<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#5D4E37">
    <meta name="description" content="Sistema de Control de Campanas Parroquiales - Funciona 100% offline">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Campanas">
    <meta name="application-name" content="Campanas Parroquiales">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon-192.png">
    
    <!-- PRELOAD CR√çTICO -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="app.js" as="script">
    <link rel="preload" href="campana1.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="campana2.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="campana3.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="emergencia.mp3" as="audio" type="audio/mpeg">
    
    <title>Campanas Parroquiales - Control Offline</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    
    <!-- Estilos cr√≠ticos inline para mejor rendimiento -->
    <style>
        /* CR√çTICO: Prevenir zoom y mejorar touch */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        input, textarea, select, button {
            font-size: 16px !important;
            touch-action: manipulation;
        }
        
        /* INPUT PIN - SIMPLIFICADO Y FUNCIONAL */
        #pin-input {
            width: 100%;
            height: 65px;
            font-size: 32px !important;
            text-align: center;
            margin: 20px 0;
            border-radius: 15px;
            border: 2px solid #8B7355;
            background: #FFFFFF;
            color: #5D4E37;
            letter-spacing: 12px;
            box-sizing: border-box;
            font-weight: bold;
            font-family: monospace;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        #pin-input:focus {
            border-color: #10B981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        #pin-input.error {
            border-color: #EF4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
            animation: shake 0.3s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* Ocultar flechas spinner */
        #pin-input::-webkit-outer-spin-button,
        #pin-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        #pin-input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Indicador offline */
        .offline-indicator {
            position: fixed;
            top: -100px;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #10B981 0%, #059669 100%);
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 13px;
            font-weight: 600;
            z-index: 9998;
            transition: top 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }
        
        .offline-indicator.show {
            top: 0;
        }
        
        .offline-indicator.offline {
            background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%);
        }
        
        /* Notificaci√≥n flotante */
        .floating-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.92);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            z-index: 9997;
            font-size: 14px;
            max-width: 85%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            transition: bottom 0.3s ease;
        }
        
        .floating-notification.show {
            bottom: 100px;
        }
        
        /* Modo standalone */
        @media (display-mode: standalone) {
            body {
                overflow: hidden;
            }
            
            .install-advice,
            #install-container {
                display: none !important;
            }
        }
        
        /* Instrucciones Bluetooth */
        .bluetooth-instructions {
            background: #E8F4FD;
            border: 2px solid #4A90E2;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            color: #2C3E50;
            text-align: left;
        }
        
        .bluetooth-instructions h4 {
            color: #4A90E2;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .bluetooth-step {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
            line-height: 1.5;
        }
        
        .bluetooth-step:before {
            content: "‚Ä¢";
            position: absolute;
            left: 5px;
            color: #4A90E2;
            font-weight: bold;
            font-size: 16px;
        }
        
        .bluetooth-warning {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #856404;
            font-weight: 600;
            text-align: center;
        }
        
        /* Consejo de instalaci√≥n */
        .install-advice {
            background: #F0F9FF;
            border: 2px dashed #3B82F6;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 14px;
            color: #1E40AF;
        }
        
        .install-advice p {
            margin: 0 0 10px 0;
            font-weight: 600;
        }
        
        .install-hints {
            background: #FEF3C7;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #92400E;
            text-align: left;
        }
        
        .install-hints span {
            display: block;
            margin: 3px 0;
            line-height: 1.4;
        }
        
        /* Loading simple */
        @keyframes pulse-simple {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .loading {
            animation: pulse-simple 1.5s ease-in-out infinite;
        }
        
        /* Reducir animaciones si el usuario lo prefiere */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- INDICADOR DE ESTADO OFFLINE -->
    <div id="offline-indicator" class="offline-indicator">
        <span id="offline-text">‚úÖ Aplicaci√≥n lista para funcionar offline</span>
    </div>
    
    <!-- NOTIFICACI√ìN FLOTANTE -->
    <div id="floating-notification" class="floating-notification" 
         role="alert" aria-live="polite" aria-atomic="true"></div>
    
    <div id="app-container">
        <!-- PANTALLA DE LOGIN -->
        <section id="login-screen" class="screen">
            <div class="logo-area">
                <div class="circle-logo">
                    <img src="icon-192.png" alt="Icono Campanas Parroquiales" id="app-icon" loading="eager">
                </div>
                <h1>Campanas Parroquiales</h1>
                <p class="subtitle">Sistema de Control Universal</p>
                <p class="subtitle" style="font-size: 0.9em; color: #666; margin-top: 5px;">
                    üì± Inst√°lela para usar 100% sin internet
                </p>
            </div>
            
            <div class="login-card">
                <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Ingrese el PIN</p>
                
                <!-- INPUT PIN OPTIMIZADO PARA M√ìVILES -->
                <input 
                    type="number"
                    id="pin-input"
                    inputmode="numeric"
                    pattern="[0-9]*"
                    maxlength="4"
                    autocomplete="off"
                    autofocus
                    placeholder="____"
                    aria-label="Ingrese el PIN de 4 d√≠gitos"
                    style="
                        -webkit-user-select: text;
                        -moz-user-select: text;
                        -ms-user-select: text;
                        user-select: text;
                    ">
                
                <button class="main-btn" onclick="verificarAcceso()" 
                        aria-label="Verificar PIN e ingresar"
                        style="margin-top: 15px;">
                    INGRESAR
                </button>
                
                <!-- Indicador de estado -->
                <div id="login-status" style="margin-top: 15px; font-size: 13px; color: #666; min-height: 18px;">
                    <span id="status-text"></span>
                </div>
            </div>
            
            <!-- CONSEJO DE INSTALACI√ìN EN LOGIN -->
            <div class="install-advice" id="install-advice">
                <p>üì± ¬øUsa esta app frecuentemente?</p>
                <button class="install-btn" id="install-login-button" 
                        style="margin: 0 auto 10px auto;"
                        aria-label="Instalar aplicaci√≥n en pantalla de inicio">
                    üì≤ INSTALAR APLICACI√ìN
                </button>
                <div class="install-hints" id="install-hints">
                    <span><strong>‚úÖ Ventajas de instalar:</strong></span>
                    <span>‚Ä¢ Funciona 100% SIN INTERNET</span>
                    <span>‚Ä¢ √çcono en pantalla principal</span>
                    <span>‚Ä¢ M√°s r√°pido que navegador</span>
                    <span style="margin-top: 8px;"><strong>üì± C√≥mo instalar:</strong></span>
                    <span><strong>Android Chrome:</strong> Men√∫ ‚Üí "Agregar a pantalla de inicio"</span>
                    <span><strong>iPhone Safari:</strong> Compartir ‚Üí "Agregar a inicio"</span>
                </div>
            </div>
            
            <!-- INSTRUCCIONES BLUETOOTH EN LOGIN -->
            <div class="bluetooth-instructions">
                <h4>üì° CONFIGURACI√ìN INICIAL (UNA SOLA VEZ)</h4>
                <div class="bluetooth-step">1. Encienda el m√≥dulo Bluetooth (1Mii o similar)</div>
                <div class="bluetooth-step">2. En su celular: Configuraci√≥n ‚Üí Bluetooth</div>
                <div class="bluetooth-step">3. Busque dispositivo bluetooth en la lista</div>
                <div class="bluetooth-step">4. Con√©ctese (parear)</div>
                <div class="bluetooth-step">5. Una vez conectado, ingrese el PIN arriba</div>
                <div class="bluetooth-warning">
                    ‚ö†Ô∏è Despu√©s de parear una vez, se conectar√° autom√°ticamente
                </div>
            </div>
            
            <!-- VERIFICACI√ìN DE RECURSOS OFFLINE -->
            <div id="offline-check" style="text-align: center; margin-top: 20px;">
                <button class="outline-btn" onclick="verificarRecursosOffline()" 
                        style="padding: 12px; font-size: 14px;">
                    üîç VERIFICAR RECURSOS OFFLINE
                </button>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    Aseg√∫rese que todos los archivos est√©n descargados
                </p>
            </div>
        </section>

        <!-- PANTALLA PRINCIPAL -->
        <section id="home-screen" class="screen hidden">
            <!-- ICONO EN PANTALLA PRINCIPAL -->
            <div class="logo-area" style="margin-top: 10px; margin-bottom: 10px;">
                <div class="circle-logo" style="width: 80px; height: 80px; margin-bottom: 10px;">
                    <img src="icon-96.png" alt="Icono" class="home-icon" loading="eager">
                </div>
            </div>
            
            <div class="header-control">
                <h2>üîî CAMPANAS PARROQUIALES</h2>
                <div id="connection-status" style="font-size: 13px; margin-top: 5px;">
                    <span id="online-status">üåê Conectado</span>
                    <span id="offline-status" style="display: none;">üì¥ Funcionando offline</span>
                </div>
            </div>

            <!-- BOTONES DE CONTROL -->
            <div class="control-grid">
                <button class="bell-btn" onclick="playAudio('campana1.mp3')" 
                        aria-label="Reproducir primer toque de campana">
                    üîî Primer Toque
                </button>
                <button class="bell-btn" onclick="playAudio('campana2.mp3')"
                        aria-label="Reproducir segundo toque de campana">
                    üîî Segundo Toque
                </button>
                <button class="bell-btn" onclick="playAudio('campana3.mp3')"
                        aria-label="Reproducir tercer toque de campana">
                    üîî Tercer Toque
                </button>
                <button class="bell-btn emergency-btn" onclick="confirmarEmergencia()"
                        aria-label="Activar alarma de emergencia">
                    ‚ö†Ô∏è üö® EMERGENCIA
                </button>
                <button class="stop-btn" onclick="detenerSonido()"
                        aria-label="Detener todos los sonidos">
                    ‚èπÔ∏è DETENER SONIDO
                </button>
            </div>

            <!-- BOT√ìN DE INSTALACI√ìN PWA (solo si no est√° instalado) -->
            <div id="install-container" class="install-box">
                <div class="install-advice">
                    <p>üí° Para acceso r√°pido y funcionamiento offline:</p>
                    <button class="install-btn" id="install-button"
                            aria-label="Instalar aplicaci√≥n para uso offline">
                        üì≤ INSTALAR APLICACI√ìN
                    </button>
                    <div class="install-hints">
                        <span><strong>‚úÖ Instale para:</strong></span>
                        <span>‚Ä¢ Usar SIN INTERNET</span>
                        <span>‚Ä¢ Acceso desde pantalla principal</span>
                        <span>‚Ä¢ Mejor rendimiento</span>
                        <span style="margin-top: 8px;"><strong>üì± Instalar en:</strong></span>
                        <span><strong>Android:</strong> Men√∫ Chrome ‚Üí "Agregar a pantalla de inicio"</span>
                        <span><strong>iPhone:</strong> Compartir Safari ‚Üí "Agregar a inicio"</span>
                    </div>
                </div>
            </div>

            <!-- NAVEGACI√ìN INFERIOR -->
            <div class="bottom-nav">
                <div class="nav-item" onclick="abrirAyuda()" aria-label="Abrir ayuda e instrucciones">
                    <div class="circulo-jl-nav">JL</div>
                    <span>Ayuda</span>
                </div>
                
                <div class="nav-item" onclick="mostrarInstruccionesBluetooth()" 
                     id="bluetooth-help-btn" aria-label="Instrucciones de conexi√≥n Bluetooth">
                    <div class="circulo-bt-nav">üì°</div>
                    <span id="bluetooth-help-text">Conectar</span>
                </div>
                
                <div class="nav-item admin-pill" onclick="intentarConfiguracion()"
                     aria-label="Configuraci√≥n administrativa">
                    ‚öôÔ∏è Admin
                </div>
            </div>
        </section>

        <!-- PANTALLA DE CONFIGURACI√ìN -->
        <section id="config-screen" class="screen hidden">
            <div class="config-header">
                <button onclick="irAHome()" aria-label="Volver a pantalla principal">‚Üê Volver</button>
                <h2>Configuraci√≥n</h2>
            </div>
            
            <div class="config-card">
                <h3>üîê Gesti√≥n de Seguridad</h3>
                <p>Cambio de PIN global (anti-robo). Requiere conexi√≥n a internet.</p>
                <button class="main-btn" onclick="cambiarPinApp()"
                        aria-label="Cambiar PIN de la aplicaci√≥n">
                    üîÑ CAMBIAR PIN GLOBAL
                </button>
                <p class="config-note" style="font-size: 12px; color: #666; margin-top: 10px;">
                    El PIN se sincroniza cuando el dispositivo tiene internet
                </p>
                
                <!-- Informaci√≥n del estado offline -->
                <div style="margin-top: 20px; padding: 15px; background: #F3F4F6; border-radius: 10px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">üìä Estado de la Aplicaci√≥n</h4>
                    <div id="config-status">
                        <p style="margin: 5px 0; font-size: 13px;">
                            <strong>Service Worker:</strong> 
                            <span id="sw-status">Verificando...</span>
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            <strong>Recursos offline:</strong> 
                            <span id="cache-status">Verificando...</span>
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            <strong>√öltima actualizaci√≥n:</strong> 
                            <span id="last-update">Verificando...</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ACCIONES DE MANTENIMIENTO -->
            <div class="config-card" style="margin-top: 20px;">
                <h3>üõ†Ô∏è Mantenimiento</h3>
                <p>Acciones para mantener la aplicaci√≥n funcionando correctamente.</p>
                
                <button class="outline-btn" onclick="recachearRecursosFaltantes()"
                        style="margin-bottom: 10px;">
                    üîÑ RECARGAR RECURSOS
                </button>
                
                <button class="outline-btn" onclick="forzarActualizacionSW()"
                        style="margin-bottom: 10px;">
                    ‚ö° FORZAR ACTUALIZACI√ìN
                </button>
                
                <button class="outline-btn" onclick="cerrarSesion()">
                    üëã CERRAR SESI√ìN
                </button>
            </div>
            
            <!-- BOT√ìN PARA VOLVER -->
            <div style="text-align: center; margin-top: 20px; padding: 0 20px;">
                <button class="outline-btn" onclick="irAHome()" style="width: 100%;"
                        aria-label="Volver a la pantalla principal">
                    üè† VOLVER A CAMPANAS
                </button>
            </div>
        </section>

        <!-- MODAL DE AYUDA -->
        <div id="help-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="drag-handle"></div>
                <h3 class="modal-title">DESCARGAR APLICACI√ìN</h3>
                <div class="qr-box">
                    <img src="qr_descarga.png" alt="QR de descarga de la aplicaci√≥n Campanas Parroquiales" 
                         class="qr-img" loading="lazy" onerror="this.src='icon-192.png'">
                </div>
                <p class="modal-text">Escanea para instalar la aplicaci√≥n</p>
                <button class="main-btn" onclick="abrirPDF()"
                        aria-label="Abrir instrucciones en PDF">
                    üìÑ INSTRUCCIONES PDF
                </button>
                <p class="contact-info">Contacto: 829-325-4348</p>
                <button class="outline-btn" onclick="cerrarAyuda()"
                        aria-label="Cerrar ventana de ayuda">
                    CERRAR
                </button>
            </div>
        </div>
    </div>

    <!-- MODALES PERSONALIZADOS (reemplazan alert/prompt) -->
    <div id="custom-alert" class="modal-overlay hidden" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 350px;">
            <p id="alert-message" style="white-space: pre-wrap; line-height: 1.6; text-align: left;"></p>
            <button class="main-btn" onclick="cerrarAlert()" style="margin-top: 20px;">OK</button>
        </div>
    </div>

    <div id="custom-prompt" class="modal-overlay hidden" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 350px;">
            <p id="prompt-message" style="white-space: pre-wrap; line-height: 1.6; text-align: left;"></p>
            <input type="text" id="prompt-input" style="
                width: 100%;
                padding: 12px;
                margin: 15px 0;
                border: 2px solid #8B7355;
                border-radius: 8px;
                font-size: 16px;
                box-sizing: border-box;
            ">
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="outline-btn" onclick="cancelarPrompt()" style="flex: 1;">Cancelar</button>
                <button class="main-btn" onclick="confirmarPrompt()" style="flex: 1;">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT DE INICIALIZACI√ìN INLINE -->
    <script>
        // Inicializaci√≥n inmediata para PWA
        (function() {
            console.log('üîî Campanas Parroquiales v1.0.0 - Iniciando');
            
            // Detectar modo standalone
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true;
            
            if (isStandalone) {
                console.log('üì± Modo standalone detectado');
                document.title = 'Campanas';
                
                // Ocultar elementos de instalaci√≥n
                setTimeout(() => {
                    const hideElements = ['.install-advice', '#install-container', '#install-advice'];
                    hideElements.forEach(sel => {
                        const els = document.querySelectorAll(sel);
                        els.forEach(el => el.style.display = 'none');
                    });
                }, 100);
            }
            
            // Funci√≥n para actualizar estado online/offline
            function updateOnlineStatus() {
                const online = navigator.onLine;
                const indicator = document.getElementById('offline-indicator');
                const offlineText = document.getElementById('offline-text');
                
                if (indicator && offlineText) {
                    if (online) {
                        indicator.classList.remove('offline');
                        offlineText.textContent = '‚úÖ Conectado a internet';
                    } else {
                        indicator.classList.add('offline');
                        offlineText.textContent = 'üì¥ Funcionando en modo offline';
                    }
                    
                    indicator.classList.add('show');
                    setTimeout(() => indicator.classList.remove('show'), 3000);
                }
                
                // Actualizar en pantalla principal
                const onlineStatus = document.getElementById('online-status');
                const offlineStatus = document.getElementById('offline-status');
                if (onlineStatus && offlineStatus) {
                    if (online) {
                        onlineStatus.style.display = 'inline';
                        offlineStatus.style.display = 'none';
                    } else {
                        onlineStatus.style.display = 'none';
                        offlineStatus.style.display = 'inline';
                    }
                }
            }
            
            // Inicializar estado
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Registrar Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('sw.js', {
                        scope: './',
                        updateViaCache: 'none'
                    })
                    .then(function(registration) {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                        
                        if (navigator.onLine) {
                            registration.update();
                        }
                        
                        if (registration.waiting) {
                            console.log('üîÑ Nueva versi√≥n esperando');
                        }
                        
                        registration.addEventListener('updatefound', function() {
                            console.log('üîÑ Nueva versi√≥n encontrada');
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', function() {
                                if (this.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('‚ú® Nueva versi√≥n lista');
                                    if (window.mostrarNotificacion) {
                                        window.mostrarNotificacion('Actualizaci√≥n disponible. Recargue la p√°gina.');
                                    }
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.error('‚ùå Error registrando Service Worker:', error);
                    });
                });
            }
            
            // Funci√≥n global de notificaciones
            window.mostrarNotificacion = function(mensaje, duracion) {
                duracion = duracion || 3000;
                const notification = document.getElementById('floating-notification');
                if (notification) {
                    notification.textContent = mensaje;
                    notification.classList.add('show');
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, duracion);
                } else {
                    console.log('üí¨ ' + mensaje);
                }
            };
            
            // Verificar estado del Service Worker
            window.verificarEstadoSW = function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(registration => {
                        if (registration) {
                            const swStatus = document.getElementById('sw-status');
                            if (swStatus) {
                                swStatus.textContent = '‚úÖ Activo';
                                swStatus.style.color = '#10B981';
                            }
                            
                            if ('caches' in window) {
                                caches.open('campanas-pwa-v1.0.0').then(cache => {
                                    cache.keys().then(keys => {
                                        const cacheStatus = document.getElementById('cache-status');
                                        if (cacheStatus) {
                                            cacheStatus.textContent = `‚úÖ ${keys.length} archivos`;
                                            cacheStatus.style.color = '#10B981';
                                        }
                                    });
                                });
                            }
                        } else {
                            const swStatus = document.getElementById('sw-status');
                            if (swStatus) {
                                swStatus.textContent = '‚ùå Inactivo';
                                swStatus.style.color = '#EF4444';
                            }
                        }
                    });
                }
            };
            
            // Recachear recursos
            window.recachearRecursosFaltantes = function() {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'FORZAR_ACTUALIZACION'
                    });
                    mostrarNotificacion('üîÑ Recacheando recursos...');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    mostrarNotificacion('‚ö†Ô∏è Service Worker no disponible');
                }
            };
            
            // Forzar actualizaci√≥n
            window.forzarActualizacionSW = function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(registration => {
                        if (registration) {
                            registration.update();
                            mostrarNotificacion('üîÑ Buscando actualizaciones...');
                            
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        }
                    });
                }
            };
            
            // Validar input PIN
            window.validarPinInput = function(input) {
                // Solo n√∫meros
                let valor = input.value.replace(/[^0-9]/g, '');
                
                // Limitar a 4 d√≠gitos
                if (valor.length > 4) {
                    valor = valor.slice(0, 4);
                }
                
                input.value = valor;
                
                // Cambiar estilo cuando est√© completo
                if (valor.length === 4) {
                    input.style.borderColor = '#10B981';
                    input.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.2)';
                    input.classList.remove('error');
                } else {
                    input.style.borderColor = '#8B7355';
                    input.style.boxShadow = 'none';
                    input.classList.remove('error');
                }
            };
            
            // Configurar input PIN al cargar
            setTimeout(() => {
                const pinInput = document.getElementById('pin-input');
                if (pinInput) {
                    // Enfocar autom√°ticamente
                    pinInput.focus();
                    
                    // Agregar validaci√≥n en tiempo real
                    pinInput.addEventListener('input', function() {
                        validarPinInput(this);
                    });
                    
                    // Enter para enviar
                    pinInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (window.verificarAcceso) {
                                verificarAcceso();
                            }
                        }
                    });
                    
                    // Prevenir paste de texto no num√©rico
                    pinInput.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const text = (e.clipboardData || window.clipboardData).getData('text');
                        const numbers = text.replace(/[^0-9]/g, '').slice(0, 4);
                        this.value = numbers;
                        validarPinInput(this);
                    });
                }
            }, 300);
            
            console.log('‚úÖ Sistema de inicializaci√≥n cargado');
        })();
    </script>
    
    <!-- Script principal -->
    <script src="app.js" defer></script>
</body>
</html>