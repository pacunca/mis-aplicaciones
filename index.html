<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#5D4E37">
    <meta name="description" content="Sistema de Control de Campanas Parroquiales - Funciona 100% offline">
    
    <!-- PWA Meta Tags MEJORADOS -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Campanas">
    <meta name="application-name" content="Campanas Parroquiales">
    
    <!-- iOS Icons MEJORADOS -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon-192.png">
    
    <!-- PRELOAD CR√çTICO para carga m√°s r√°pida -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="app.js" as="script">
    <link rel="preload" href="campana1.mp3" as="audio" type="audio/mpeg">
    <link rel="preload" href="icon-192.png" as="image" type="image/png">
    
    <title>Campanas Parroquiales - Control Offline</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icono.png" type="image/png">
    
    <!-- Estilos optimizados para PWA offline -->
    <style>
        /* Indicador de estado offline */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #10B981 0%, #059669 100%);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 13px;
            font-weight: 600;
            z-index: 9998;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .offline-indicator.show {
            transform: translateY(0);
        }
        
        .offline-indicator.offline {
            background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%);
        }
        
        /* Notificaci√≥n flotante */
        .floating-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 9997;
            font-size: 14px;
            max-width: 85%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .floating-notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Mejoras para modo standalone */
        @media (display-mode: standalone) {
            body {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                overflow: hidden;
            }
            
            /* Ocultar elementos de instalaci√≥n cuando ya est√° instalado */
            .install-advice,
            #install-container,
            #install-advice {
                display: none !important;
            }
            
            /* Mejor padding para safe areas */
            .screen {
                padding-top: env(safe-area-inset-top, 20px) !important;
                padding-bottom: env(safe-area-inset-bottom, 120px) !important;
            }
            
            .bottom-nav {
                bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            }
        }
        
        /* Instrucciones Bluetooth */
        .bluetooth-instructions {
            background: #E8F4FD;
            border: 2px solid #4A90E2;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            color: #2C3E50;
            text-align: left;
        }
        
        .bluetooth-instructions h4 {
            color: #4A90E2;
            margin-top: 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .bluetooth-step {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .bluetooth-step:before {
            content: "‚Ä¢";
            position: absolute;
            left: 5px;
            color: #4A90E2;
            font-weight: bold;
        }
        
        .bluetooth-warning {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #856404;
            font-weight: 600;
        }
        
        /* Input PIN VISIBLE para personas mayores */
        #pin-input {
            width: 100%;
            height: 65px;
            font-size: 32px;
            text-align: center;
            margin: 20px 0;
            border-radius: 15px;
            border: 2px solid #8B7355;
            background: #FFFFFF;
            color: #5D4E37;
            letter-spacing: 12px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            font-weight: bold;
            font-family: monospace;
        }
        
        /* Cambiado de type="password" a type="text" para mostrar n√∫meros */
        #pin-input::placeholder {
            letter-spacing: normal;
            color: #aaa;
            font-weight: normal;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        #pin-input:focus {
            border-color: #10B981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
            outline: none;
        }
        
        #pin-input.error {
            border-color: #EF4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }
        
        /* Ocultar flechas en navegadores */
        #pin-input::-webkit-outer-spin-button,
        #pin-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        #pin-input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Bot√≥n de instalaci√≥n MEJORADO */
        .install-advice {
            background: #F0F9FF;
            border: 2px dashed #3B82F6;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 14px;
            color: #1E40AF;
            transition: all 0.3s ease;
        }
        
        .install-advice:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.15);
        }
        
        .install-advice p {
            margin: 0 0 10px 0;
            font-weight: 600;
        }
        
        /* Instrucciones espec√≠ficas por navegador */
        .install-hints {
            background: #FEF3C7;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #92400E;
            text-align: left;
        }
        
        .install-hints span {
            display: block;
            margin: 3px 0;
        }
        
        /* Animaciones de carga */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Alto contraste */
        @media (prefers-contrast: high) {
            #pin-input {
                border-width: 3px;
            }
            
            button {
                border: 2px solid #000000;
            }
        }
        
        /* Modo oscuro compatible */
        @media (prefers-color-scheme: dark) {
            .bluetooth-instructions {
                background: #1E293B;
                border-color: #3B82F6;
                color: #E2E8F0;
            }
            
            .install-advice {
                background: #1E3A8A;
                color: #DBEAFE;
            }
            
            .install-hints {
                background: #78350F;
                color: #FDE68A;
            }
        }
    </style>
</head>
<body>
    <!-- INDICADOR DE ESTADO OFFLINE -->
    <div id="offline-indicator" class="offline-indicator">
        <span id="offline-text">‚úÖ Aplicaci√≥n lista para funcionar offline</span>
    </div>
    
    <!-- NOTIFICACI√ìN FLOTANTE -->
    <div id="floating-notification" class="floating-notification"></div>
    
    <div id="app-container">
        <!-- PANTALLA DE LOGIN -->
        <section id="login-screen" class="screen">
            <div class="logo-area">
                <div class="circle-logo">
                    <img src="icon-192.png" alt="Icono Campanas Parroquiales" id="app-icon" loading="eager">
                </div>
                <h1>Campanas Parroquiales</h1>
                <p class="subtitle">Sistema de Control Universal</p>
                <p class="subtitle" style="font-size: 0.9em; color: #666; margin-top: 5px;">
                    üì± Inst√°lela para usar 100% sin internet
                </p>
            </div>
            
            <div class="login-card">
                <p>Ingrese el PIN</p>
                
                <!-- INPUT CON TECLADO NATIVO VISIBLE para personas mayores -->
                <input type="text"
                       id="pin-input"
                       inputmode="numeric"
                       pattern="[0-9]*"
                       maxlength="4"
                       autocomplete="off"
                       autofocus
                       placeholder="____"
                       oninput="validarPinInput(this)"
                       aria-label="Ingrese el PIN de 4 d√≠gitos">
                
                <button class="main-btn" onclick="verificarAcceso()" aria-label="Verificar PIN e ingresar">
                    INGRESAR
                </button>
                
                <!-- Indicador de estado -->
                <div id="login-status" style="margin-top: 15px; font-size: 13px; color: #666; min-height: 18px;">
                    <span id="status-text"></span>
                    <span id="status-loading" class="loading" style="display: none;">üîÑ Verificando recursos...</span>
                </div>
            </div>
            
            <!-- CONSEJO DE INSTALACI√ìN EN LOGIN -->
            <div class="install-advice" id="install-advice">
                <p>üì± ¬øUsa esta app frecuentemente?</p>
                <button class="install-btn" id="install-login-button" style="margin: 0 auto 10px auto;"
                        aria-label="Instalar aplicaci√≥n en pantalla de inicio">
                    üì≤ INSTALAR APLICACI√ìN
                </button>
                <div class="install-hints" id="install-hints">
                    <span><strong>‚úÖ Ventajas de instalar:</strong></span>
                    <span>‚Ä¢ Funciona 100% SIN INTERNET</span>
                    <span>‚Ä¢ √çcono en pantalla principal</span>
                    <span>‚Ä¢ M√°s r√°pido que navegador</span>
                    <span style="margin-top: 8px;"><strong>üì± C√≥mo instalar:</strong></span>
                    <span><strong>Android Chrome:</strong> Men√∫ ‚Üí "Agregar a pantalla de inicio"</span>
                    <span><strong>iPhone Safari:</strong> Compartir ‚Üí "Agregar a inicio"</span>
                </div>
            </div>
            
            <!-- INSTRUCCIONES BLUETOOTH EN LOGIN -->
            <div class="bluetooth-instructions">
                <h4>üì° CONFIGURACI√ìN INICIAL (UNA SOLA VEZ)</h4>
                <div class="bluetooth-step">1. Encienda el m√≥dulo Bluetooth (1Mii o similar)</div>
                <div class="bluetooth-step">2. En su celular: Configuraci√≥n ‚Üí Bluetooth</div>
                <div class="bluetooth-step">3. Busque dispositivo bluetooth en la lista</div>
                <div class="bluetooth-step">4. Con√©ctese (parear)</div>
                <div class="bluetooth-step">5. Una vez conectado, ingrese el PIN arriba</div>
                <div class="bluetooth-warning">
                    ‚ö†Ô∏è Despu√©s de parear una vez, se conectar√° autom√°ticamente
                </div>
            </div>
            
            <!-- VERIFICACI√ìN DE RECURSOS OFFLINE -->
            <div id="offline-check" style="text-align: center; margin-top: 20px;">
                <button class="outline-btn" onclick="verificarRecursosOffline()" 
                        style="padding: 12px; font-size: 14px;">
                    üîç VERIFICAR RECURSOS OFFLINE
                </button>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    Aseg√∫rese que todos los archivos est√©n descargados
                </p>
            </div>
        </section>

        <!-- PANTALLA PRINCIPAL -->
        <section id="home-screen" class="screen hidden">
            <!-- ICONO EN PANTALLA PRINCIPAL -->
            <div class="logo-area" style="margin-top: 10px; margin-bottom: 10px;">
                <div class="circle-logo" style="width: 80px; height: 80px; margin-bottom: 10px;">
                    <img src="icon-96.png" alt="Icono" class="home-icon" loading="eager">
                </div>
            </div>
            
            <div class="header-control">
                <h2>üîî CAMPANAS PARROQUIALES</h2>
                <div id="connection-status" style="font-size: 13px; margin-top: 5px;">
                    <span id="online-status">üåê Conectado</span>
                    <span id="offline-status" style="display: none;">üì¥ Funcionando offline</span>
                </div>
            </div>

            <!-- BOTONES DE CONTROL -->
            <div class="control-grid">
                <button class="bell-btn" onclick="playAudio('campana1.mp3')" 
                        aria-label="Reproducir primer toque de campana">
                    üîî Primer Toque
                </button>
                <button class="bell-btn" onclick="playAudio('campana2.mp3')"
                        aria-label="Reproducir segundo toque de campana">
                    üîî Segundo Toque
                </button>
                <button class="bell-btn" onclick="playAudio('campana3.mp3')"
                        aria-label="Reproducir tercer toque de campana">
                    üîî Tercer Toque
                </button>
                <button class="bell-btn emergency-btn" onclick="confirmarEmergencia()"
                        aria-label="Activar alarma de emergencia">
                    ‚ö†Ô∏è üö® EMERGENCIA
                </button>
                <button class="stop-btn" onclick="detenerSonido()"
                        aria-label="Detener todos los sonidos">
                    ‚èπÔ∏è DETENER SONIDO
                </button>
            </div>

            <!-- ESTADO DE LA APLICACI√ìN -->
            <div id="app-status" class="status-bar" style="margin: 20px 0; display: none;">
                <div id="status-content"></div>
            </div>

            <!-- BOT√ìN DE INSTALACI√ìN PWA MEJORADO (solo se muestra si no est√° instalado) -->
            <div id="install-container" class="install-box">
                <div class="install-advice">
                    <p>üí° Para acceso r√°pido y funcionamiento offline:</p>
                    <button class="install-btn" id="install-button"
                            aria-label="Instalar aplicaci√≥n para uso offline">
                        üì≤ INSTALAR APLICACI√ìN
                    </button>
                    <div class="install-hints">
                        <span><strong>‚úÖ Instale para:</strong></span>
                        <span>‚Ä¢ Usar SIN INTERNET</span>
                        <span>‚Ä¢ Acceso desde pantalla principal</span>
                        <span>‚Ä¢ Mejor rendimiento</span>
                        <span style="margin-top: 8px;"><strong>üì± Instalar en:</strong></span>
                        <span><strong>Android:</strong> Men√∫ Chrome ‚Üí "Agregar a pantalla de inicio"</span>
                        <span><strong>iPhone:</strong> Compartir Safari ‚Üí "Agregar a inicio"</span>
                    </div>
                </div>
            </div>

            <!-- NAVEGACI√ìN INFERIOR -->
            <div class="bottom-nav">
                <div class="nav-item" onclick="abrirAyuda()" aria-label="Abrir ayuda e instrucciones">
                    <div class="circulo-jl-nav">JL</div>
                    <span>Ayuda</span>
                </div>
                
                <!-- BOT√ìN CONEXI√ìN (AHORA INSTRUCCIONES) -->
                <div class="nav-item" onclick="mostrarInstruccionesBluetooth()" 
                     id="bluetooth-help-btn" aria-label="Instrucciones de conexi√≥n Bluetooth">
                    <div class="circulo-bt-nav">üì°</div>
                    <span id="bluetooth-help-text">Conectar</span>
                </div>
                
                <div class="nav-item admin-pill" onclick="intentarConfiguracion()"
                     aria-label="Configuraci√≥n administrativa">
                    ‚öôÔ∏è Admin
                </div>
            </div>
        </section>

        <!-- PANTALLA DE CONFIGURACI√ìN SIMPLIFICADA -->
        <section id="config-screen" class="screen hidden">
            <div class="config-header">
                <button onclick="irAHome()" aria-label="Volver a pantalla principal">‚Üê Volver</button>
                <h2>Configuraci√≥n</h2>
            </div>
            
            <!-- SOLO SEGURIDAD, SIN BLUETOOTH COMPLEJO -->
            <div class="config-card">
                <h3>üîê Gesti√≥n de Seguridad</h3>
                <p>Cambio de PIN global (anti-robo). Requiere conexi√≥n a internet.</p>
                <button class="main-btn" onclick="cambiarPinApp()"
                        aria-label="Cambiar PIN de la aplicaci√≥n">
                    üîÑ CAMBIAR PIN GLOBAL
                </button>
                <p class="config-note" style="font-size: 12px; color: #666; margin-top: 10px;">
                    El PIN se sincroniza cuando el dispositivo tiene internet
                </p>
                
                <!-- Informaci√≥n del estado offline -->
                <div style="margin-top: 20px; padding: 15px; background: #F3F4F6; border-radius: 10px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">üìä Estado de la Aplicaci√≥n</h4>
                    <div id="config-status">
                        <p style="margin: 5px 0; font-size: 13px;">
                            <strong>Service Worker:</strong> 
                            <span id="sw-status">Verificando...</span>
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            <strong>Recursos offline:</strong> 
                            <span id="cache-status">Verificando...</span>
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            <strong>√öltima actualizaci√≥n:</strong> 
                            <span id="last-update">Verificando...</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ACCIONES DE MANTENIMIENTO -->
            <div class="config-card" style="margin-top: 20px;">
                <h3>üõ†Ô∏è Mantenimiento</h3>
                <p>Acciones para mantener la aplicaci√≥n funcionando correctamente.</p>
                
                <button class="outline-btn" onclick="recachearRecursosFaltantes()"
                        style="margin-bottom: 10px;">
                    üîÑ RECARGAR RECURSOS
                </button>
                
                <button class="outline-btn" onclick="forzarActualizacionSW()"
                        style="margin-bottom: 10px;">
                    ‚ö° FORZAR ACTUALIZACI√ìN
                </button>
                
                <button class="outline-btn" onclick="cerrarSesion()">
                    üëã CERRAR SESI√ìN
                </button>
            </div>
            
            <!-- BOT√ìN PARA VOLVER -->
            <div style="text-align: center; margin-top: 20px; padding: 0 20px;">
                <button class="outline-btn" onclick="irAHome()" style="width: 100%;"
                        aria-label="Volver a la pantalla principal">
                    üè† VOLVER A CAMPANAS
                </button>
            </div>
        </section>

        <!-- MODAL DE AYUDA -->
        <div id="help-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="drag-handle"></div>
                <h3 class="modal-title">DESCARGAR APLICACI√ìN</h3>
                <div class="qr-box">
                    <img src="qr_descarga.png" alt="QR de descarga de la aplicaci√≥n Campanas Parroquiales" 
                         class="qr-img" loading="lazy" onerror="this.src='icon-192.png'">
                </div>
                <p class="modal-text">Escanea para instalar la aplicaci√≥n</p>
                <button class="main-btn" onclick="abrirPDF()"
                        aria-label="Abrir instrucciones en PDF">
                    üìÑ INSTRUCCIONES PDF
                </button>
                <p class="contact-info">Contacto: 829-325-4348</p>
                <button class="outline-btn" onclick="cerrarAyuda()"
                        aria-label="Cerrar ventana de ayuda">
                    CERRAR
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS CR√çTICOS - Optimizados para PWA -->
    <script>
        // Script de inicializaci√≥n mejorado para PWA offline
        (function() {
            console.log('üîî Campanas Parroquiales - Iniciando en modo PWA');
            
            // Detectar si estamos en modo standalone (ya instalado)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true;
            
            // Actualizar t√≠tulo si est√° instalado
            if (isStandalone) {
                document.title = 'Campanas (Offline)';
                console.log('üì± Modo standalone detectado - Aplicaci√≥n instalada');
                
                // Ocultar elementos de instalaci√≥n
                setTimeout(() => {
                    const installElements = document.querySelectorAll('.install-advice, #install-container');
                    installElements.forEach(el => {
                        if (el) el.style.display = 'none';
                    });
                }, 100);
            }
            
            // Verificar conexi√≥n inicial
            function updateOnlineStatus() {
                const online = navigator.onLine;
                const indicator = document.getElementById('offline-indicator');
                const offlineText = document.getElementById('offline-text');
                const onlineStatus = document.getElementById('online-status');
                const offlineStatus = document.getElementById('offline-status');
                
                if (indicator && offlineText) {
                    if (online) {
                        indicator.classList.remove('offline');
                        offlineText.textContent = '‚úÖ Conectado a internet';
                    } else {
                        indicator.classList.add('offline');
                        offlineText.textContent = 'üì¥ Funcionando en modo offline';
                    }
                    
                    // Mostrar indicador brevemente
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 3000);
                }
                
                // Actualizar en pantalla principal
                if (onlineStatus && offlineStatus) {
                    if (online) {
                        onlineStatus.style.display = 'inline';
                        offlineStatus.style.display = 'none';
                    } else {
                        onlineStatus.style.display = 'none';
                        offlineStatus.style.display = 'inline';
                    }
                }
            }
            
            // Inicializar estado de conexi√≥n
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Registrar Service Worker para PWA offline
            if ('serviceWorker' in navigator) {
                // Esperar a que la p√°gina cargue completamente
                window.addEventListener('load', function() {
                    // Registrar con estrategia agresiva
                    navigator.serviceWorker.register('sw.js', {
                        scope: './',
                        updateViaCache: 'none'
                    })
                    .then(function(registration) {
                        console.log('‚úÖ Service Worker registrado exitosamente:', registration.scope);
                        
                        // Forzar actualizaci√≥n si hay conexi√≥n
                        if (navigator.onLine) {
                            registration.update();
                        }
                        
                        // Verificar si hay una nueva versi√≥n esperando
                        if (registration.waiting) {
                            console.log('üîÑ Nueva versi√≥n del Service Worker esperando');
                            mostrarNotificacion('Nueva versi√≥n disponible. Recargue para actualizar.');
                        }
                        
                        // Escuchar actualizaciones
                        registration.addEventListener('updatefound', function() {
                            console.log('üîÑ Nueva versi√≥n del Service Worker encontrada');
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', function() {
                                if (this.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('‚ú® Nueva versi√≥n instalada - Lista para activar');
                                    mostrarNotificacion('Actualizaci√≥n lista. Recargue para aplicar cambios.');
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.error('‚ùå Error registrando Service Worker:', error);
                    });
                });
            } else {
                console.warn('‚ö†Ô∏è Service Worker no soportado - La aplicaci√≥n funcionar√° en modo online');
            }
            
            // Funci√≥n para mostrar notificaciones flotantes
            window.mostrarNotificacion = function(mensaje, duracion = 3000) {
                const notification = document.getElementById('floating-notification');
                if (notification) {
                    notification.textContent = mensaje;
                    notification.classList.add('show');
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, duracion);
                } else {
                    console.log('üí¨ ' + mensaje);
                }
            };
            
            // Funci√≥n para verificar estado del Service Worker
            window.verificarEstadoSW = function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(registration => {
                        if (registration) {
                            const swStatus = document.getElementById('sw-status');
                            if (swStatus) {
                                swStatus.textContent = '‚úÖ Activo';
                                swStatus.style.color = '#10B981';
                            }
                            
                            // Verificar cache
                            if ('caches' in window) {
                                caches.open('campanas-pwav1').then(cache => {
                                    cache.keys().then(keys => {
                                        const cacheStatus = document.getElementById('cache-status');
                                        if (cacheStatus) {
                                            const total = keys.length;
                                            cacheStatus.textContent = `‚úÖ ${total} archivos cacheados`;
                                            cacheStatus.style.color = '#10B981';
                                        }
                                    });
                                });
                            }
                        } else {
                            const swStatus = document.getElementById('sw-status');
                            if (swStatus) {
                                swStatus.textContent = '‚ùå Inactivo';
                                swStatus.style.color = '#EF4444';
                            }
                        }
                    });
                }
            };
            
            // Funci√≥n para recachear recursos
            window.recachearRecursosFaltantes = function() {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'FORZAR_ACTUALIZACION'
                    });
                    mostrarNotificacion('üîÑ Recacheando recursos...');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    mostrarNotificacion('‚ö†Ô∏è Service Worker no disponible');
                }
            };
            
            // Funci√≥n para forzar actualizaci√≥n
            window.forzarActualizacionSW = function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(registration => {
                        if (registration) {
                            registration.update();
                            mostrarNotificacion('üîÑ Buscando actualizaciones...');
                            
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        }
                    });
                }
            };
            
            // Mostrar notificaci√≥n de bienvenida
            setTimeout(() => {
                if (isStandalone) {
                    mostrarNotificacion('‚úÖ Aplicaci√≥n instalada - Lista para uso offline');
                }
            }, 1500);
            
            console.log('‚úÖ Sistema de inicializaci√≥n PWA cargado');
        })();
    </script>
    
<!-- Script de emergencia para bucles infinitos -->
<script>
  // Detectar bucles de recarga
  (function() {
    // Contador de recargas
    let reloadCount = sessionStorage.getItem('reloadCount') || 0;
    reloadCount++;
    sessionStorage.setItem('reloadCount', reloadCount);
    
    console.log('üîÑ Recarga #' + reloadCount);
    
    // Si hay m√°s de 3 recargas en 5 segundos, hay un bucle
    if (reloadCount > 3) {
      console.error('üîÑ BUCLE INFINITO DETECTADO - Tomando medidas');
      
      // 1. Limpiar sessionStorage
      sessionStorage.removeItem('reloadCount');
      
      // 2. Desregistrar Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            registration.unregister();
            console.log('üóëÔ∏è SW desregistrado');
          });
        });
      }
      
      // 3. Limpiar caches
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          cacheNames.forEach(cacheName => {
            caches.delete(cacheName);
            console.log('üóëÔ∏è Cache limpiada:', cacheName);
          });
        });
      }
      
      // 4. Recargar sin SW
      setTimeout(() => {
        window.location.href = window.location.href + '?nocache=' + Date.now();
      }, 500);
    }
    
    // Resetear contador despu√©s de 5 segundos
    setTimeout(() => {
      sessionStorage.setItem('reloadCount', 0);
    }, 5000);
  })();
</script>

    <!-- Script principal -->
    <script src="app.js" defer></script>
</body>
</html>